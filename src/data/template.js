import { OUTDOOR_TASK_NAMES } from './constants.js'
import { uuid } from '../lib/uuid.js'

const isOutdoor = (name) => OUTDOOR_TASK_NAMES.includes(name)

export const DEFAULT_TEMPLATE = {
  id: 'template-standard-60',
  name: 'Base 60-Day Schedule',
  description: 'Base schedule aligned to the sample construction sequence with flexible exterior work.',
  build_days: 60,
  tasks: [
    // FOUNDATION (sequential)
    {
      id: uuid(),
      name: 'Stake Lot',
      trade: 'excavation',
      phase: 'foundation',
      track: 'foundation',
      duration: 1,
      dependencies: [],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Stake Lot'),
      lead_time_days: 0,
      sort_order: 1,
    },
    {
      id: uuid(),
      name: 'Form / Gravel Deliver',
      trade: 'concrete',
      phase: 'foundation',
      track: 'foundation',
      duration: 1,
      dependencies: [{ task_name: 'Stake Lot', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Form / Gravel Deliver'),
      lead_time_days: 0,
      sort_order: 2,
    },
    {
      id: uuid(),
      name: 'Form Checks / Elevation Certificate',
      trade: 'other',
      phase: 'foundation',
      track: 'foundation',
      duration: 1,
      dependencies: [{ task_name: 'Form / Gravel Deliver', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Form Checks / Elevation Certificate'),
      lead_time_days: 0,
      sort_order: 3,
    },
    {
      id: uuid(),
      name: 'Plumbing Slab',
      trade: 'plumbing',
      phase: 'foundation',
      track: 'foundation',
      duration: 1,
      dependencies: [{ task_name: 'Form Checks / Elevation Certificate', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Plumbing Slab'),
      lead_time_days: 0,
      sort_order: 4,
    },
    {
      id: uuid(),
      name: 'Plumbing Slab Inspection',
      trade: 'plumbing',
      phase: 'foundation',
      track: 'foundation',
      duration: 1,
      dependencies: [{ task_name: 'Plumbing Slab', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'PRE',
      is_outdoor: isOutdoor('Plumbing Slab Inspection'),
      lead_time_days: 0,
      sort_order: 5,
    },
    {
      id: uuid(),
      name: 'Prep Slab / Sling Gravel',
      trade: 'concrete',
      phase: 'foundation',
      track: 'foundation',
      duration: 1,
      dependencies: [{ task_name: 'Plumbing Slab Inspection', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Prep Slab / Sling Gravel'),
      lead_time_days: 0,
      sort_order: 6,
    },
    {
      id: uuid(),
      name: 'Slab Inspection',
      trade: 'concrete',
      phase: 'foundation',
      track: 'foundation',
      duration: 1,
      dependencies: [{ task_name: 'Prep Slab / Sling Gravel', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'PRE',
      is_outdoor: isOutdoor('Slab Inspection'),
      lead_time_days: 0,
      sort_order: 7,
    },
    {
      id: uuid(),
      name: 'Foundation Pour',
      trade: 'concrete',
      phase: 'foundation',
      track: 'foundation',
      duration: 1,
      dependencies: [{ task_name: 'Slab Inspection', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Foundation Pour'),
      lead_time_days: 0,
      sort_order: 8,
    },
    {
      id: uuid(),
      name: 'Slab Grade',
      trade: 'concrete',
      phase: 'foundation',
      track: 'foundation',
      duration: 1,
      dependencies: [{ task_name: 'Foundation Pour', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Slab Grade'),
      lead_time_days: 0,
      sort_order: 9,
    },

    // ROUGHS (sequential)
    {
      id: uuid(),
      name: 'Frame Delivery',
      trade: 'framing',
      phase: 'framing',
      track: 'structure',
      duration: 1,
      dependencies: [{ task_name: 'Slab Grade', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Frame Delivery'),
      lead_time_days: 0,
      sort_order: 10,
    },
    {
      id: uuid(),
      name: 'Framing',
      trade: 'framing',
      phase: 'framing',
      track: 'structure',
      duration: 4,
      dependencies: [{ task_name: 'Frame Delivery', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Framing'),
      lead_time_days: 0,
      sort_order: 11,
    },
    {
      id: uuid(),
      name: 'Window & Door Install',
      trade: 'windows',
      phase: 'framing',
      track: 'structure',
      duration: 1,
      dependencies: [{ task_name: 'Framing', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Window & Door Install'),
      lead_time_days: 0,
      sort_order: 12,
    },
    {
      id: uuid(),
      name: 'Plumbing Rough',
      trade: 'plumbing',
      phase: 'mechanical',
      track: 'structure',
      duration: 1,
      dependencies: [{ task_name: 'Window & Door Install', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 13,
    },
    {
      id: uuid(),
      name: 'HVAC Rough',
      trade: 'hvac',
      phase: 'mechanical',
      track: 'structure',
      duration: 1,
      dependencies: [{ task_name: 'Plumbing Rough', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 14,
    },
    {
      id: uuid(),
      name: 'Gas Rough',
      trade: 'plumbing',
      phase: 'mechanical',
      track: 'structure',
      duration: 1,
      dependencies: [{ task_name: 'HVAC Rough', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 15,
    },
    {
      id: uuid(),
      name: 'Electric Rough',
      trade: 'electrical',
      phase: 'mechanical',
      track: 'structure',
      duration: 1,
      dependencies: [{ task_name: 'Gas Rough', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 16,
    },
    {
      id: uuid(),
      name: 'Low Volt Rough',
      trade: 'electrical',
      phase: 'mechanical',
      track: 'structure',
      duration: 1,
      dependencies: [{ task_name: 'Electric Rough', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 17,
    },
    {
      id: uuid(),
      name: 'Roofing',
      trade: 'roofing',
      phase: 'framing',
      track: 'structure',
      duration: 1,
      dependencies: [{ task_name: 'Low Volt Rough', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Roofing'),
      lead_time_days: 0,
      sort_order: 18,
    },
    {
      id: uuid(),
      name: 'Rough Inspection',
      trade: 'other',
      phase: 'mechanical',
      track: 'structure',
      duration: 1,
      dependencies: [{ task_name: 'Roofing', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'RME',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 19,
    },
    {
      id: uuid(),
      name: 'Insulation / Drywall Delivery',
      trade: 'insulation',
      phase: 'insulation_drywall',
      track: 'structure',
      duration: 1,
      dependencies: [{ task_name: 'Rough Inspection', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 20,
    },
    {
      id: uuid(),
      name: 'Rough Inspection (Final)',
      trade: 'other',
      phase: 'insulation_drywall',
      track: 'structure',
      duration: 1,
      dependencies: [{ task_name: 'Insulation / Drywall Delivery', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'RME',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 21,
    },

    // POST DRYWALL (sequential)
    {
      id: uuid(),
      name: 'Drywall Hang',
      trade: 'drywall',
      phase: 'insulation_drywall',
      track: 'interior',
      duration: 10,
      dependencies: [{ task_name: 'Rough Inspection (Final)', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'DRY',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 30,
    },
    {
      id: uuid(),
      name: 'Trim Deliver / Ext Knobs',
      trade: 'trim',
      phase: 'finishes',
      track: 'interior',
      duration: 1,
      dependencies: [{ task_name: 'Drywall Hang', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 31,
    },
    {
      id: uuid(),
      name: 'Trim Install',
      trade: 'trim',
      phase: 'finishes',
      track: 'interior',
      duration: 1,
      dependencies: [{ task_name: 'Trim Deliver / Ext Knobs', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 32,
    },
    {
      id: uuid(),
      name: 'First Paint',
      trade: 'paint',
      phase: 'finishes',
      track: 'interior',
      duration: 2,
      dependencies: [{ task_name: 'Trim Install', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 33,
    },
    {
      id: uuid(),
      name: 'Cabinet Delivery',
      trade: 'cabinets',
      phase: 'finishes',
      track: 'interior',
      duration: 1,
      dependencies: [{ task_name: 'First Paint', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 34,
    },
    {
      id: uuid(),
      name: 'Cabinet Install / Appliance Delivery',
      trade: 'cabinets',
      phase: 'finishes',
      track: 'interior',
      duration: 1,
      dependencies: [{ task_name: 'Cabinet Delivery', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 35,
    },
    {
      id: uuid(),
      name: 'Lighting Delivery / Electric Final / Countertop Template',
      trade: 'electrical',
      phase: 'finishes',
      track: 'interior',
      duration: 1,
      dependencies: [{ task_name: 'Cabinet Install / Appliance Delivery', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'FEL',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 36,
    },
    {
      id: uuid(),
      name: 'Interior Knobs Delivery / Rough Clean',
      trade: 'trim',
      phase: 'finishes',
      track: 'interior',
      duration: 1,
      dependencies: [{ task_name: 'Lighting Delivery / Electric Final / Countertop Template', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 37,
    },
    {
      id: uuid(),
      name: 'Tile Install',
      trade: 'flooring',
      phase: 'finishes',
      track: 'interior',
      duration: 2,
      dependencies: [{ task_name: 'Interior Knobs Delivery / Rough Clean', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 38,
    },
    {
      id: uuid(),
      name: 'Flooring Install / Final Trim Delivery / Attic Blow',
      trade: 'flooring',
      phase: 'finishes',
      track: 'interior',
      duration: 2,
      dependencies: [{ task_name: 'Tile Install', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 39,
    },
    {
      id: uuid(),
      name: 'Final Trim Install / Countertop Install',
      trade: 'trim',
      phase: 'finishes',
      track: 'interior',
      duration: 1,
      dependencies: [{ task_name: 'Flooring Install / Final Trim Delivery / Attic Blow', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 40,
    },
    {
      id: uuid(),
      name: 'HVAC Final / Cabinet Punch / Backsplash',
      trade: 'hvac',
      phase: 'final',
      track: 'interior',
      duration: 1,
      dependencies: [{ task_name: 'Final Trim Install / Countertop Install', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'FHV',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 41,
    },
    {
      id: uuid(),
      name: 'Plumbing Final',
      trade: 'plumbing',
      phase: 'final',
      track: 'interior',
      duration: 2,
      dependencies: [{ task_name: 'HVAC Final / Cabinet Punch / Backsplash', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'FPL',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 42,
    },
    {
      id: uuid(),
      name: 'Final Paint',
      trade: 'paint',
      phase: 'final',
      track: 'interior',
      duration: 2,
      dependencies: [{ task_name: 'Plumbing Final', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 43,
    },
    {
      id: uuid(),
      name: 'Afterpaint (Blinds, Shelving, Bath Hardware, Mirrors, Shower Door)',
      trade: 'trim',
      phase: 'final',
      track: 'interior',
      duration: 1,
      dependencies: [{ task_name: 'Final Paint', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 44,
    },
    {
      id: uuid(),
      name: 'Security Final',
      trade: 'electrical',
      phase: 'final',
      track: 'interior',
      duration: 1,
      dependencies: [{ task_name: 'Afterpaint (Blinds, Shelving, Bath Hardware, Mirrors, Shower Door)', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 45,
    },
    {
      id: uuid(),
      name: 'Clean',
      trade: 'cleaning',
      phase: 'final',
      track: 'interior',
      duration: 1,
      dependencies: [{ task_name: 'Security Final', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 46,
    },
    {
      id: uuid(),
      name: 'Final Appliance Delivery',
      trade: 'appliances',
      phase: 'final',
      track: 'interior',
      duration: 1,
      dependencies: [{ task_name: 'Clean', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 47,
    },

    // FINAL (sequential)
    {
      id: uuid(),
      name: 'Final Inspection',
      trade: 'other',
      phase: 'final',
      track: 'final',
      duration: 1,
      dependencies: [{ task_name: 'Final Appliance Delivery', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'FIN',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 90,
    },
    {
      id: uuid(),
      name: 'Punch Complete',
      trade: 'other',
      phase: 'final',
      track: 'final',
      duration: 1,
      dependencies: [{ task_name: 'Final Inspection', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'COO',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 91,
    },
    {
      id: uuid(),
      name: 'Buyer Walkthrough',
      trade: 'other',
      phase: 'final',
      track: 'final',
      duration: 1,
      dependencies: [{ task_name: 'Punch Complete', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 92,
    },
    {
      id: uuid(),
      name: 'Handover',
      trade: 'other',
      phase: 'final',
      track: 'final',
      duration: 1,
      dependencies: [{ task_name: 'Buyer Walkthrough', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 93,
    },
  ],
}

const cloneTasks = (tasks, durationScale = 1) =>
  (tasks ?? []).map((task) => ({
    ...task,
    id: uuid(),
    duration: Math.max(1, Math.round((task.duration ?? 1) * durationScale)),
  }))

const buildTemplateVariant = ({ id, name, build_days, durationScale }) => ({
  id,
  name,
  description: `${name} template.`,
  build_days,
  tasks: cloneTasks(DEFAULT_TEMPLATE.tasks, durationScale),
})

export const TEMPLATE_COTTAGE = buildTemplateVariant({
  id: 'template-cottage-115',
  name: 'Cottage Standard',
  build_days: 115,
  durationScale: 115 / 60,
})

export const TEMPLATE_RANCHER = buildTemplateVariant({
  id: 'template-rancher-130',
  name: 'Rancher Standard',
  build_days: 130,
  durationScale: 130 / 60,
})

export const TEMPLATE_TOWNHOME = buildTemplateVariant({
  id: 'template-townhome-145',
  name: 'Townhome Standard',
  build_days: 145,
  durationScale: 145 / 60,
})

export const TEMPLATES = [TEMPLATE_COTTAGE, TEMPLATE_RANCHER, TEMPLATE_TOWNHOME]
