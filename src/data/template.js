import { OUTDOOR_TASK_NAMES } from './constants.js'
import { uuid } from '../lib/uuid.js'

const isOutdoor = (name) => OUTDOOR_TASK_NAMES.includes(name)

export const DEFAULT_TEMPLATE = {
  id: 'template-standard-135',
  name: 'Standard 135-Day Template',
  description: 'Default BuildFlow template with parallel interior/exterior tracks and inspection gates.',
  build_days: 135,
  tasks: [
    // FOUNDATION (sequential)
    {
      id: uuid(),
      name: 'Stake Lot',
      trade: 'other',
      phase: 'pre_construction',
      track: 'foundation',
      duration: 1,
      dependencies: [],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: true,
      lead_time_days: 0,
      sort_order: 1,
    },
    {
      id: uuid(),
      name: 'Excavation',
      trade: 'excavation',
      phase: 'foundation',
      track: 'foundation',
      duration: 2,
      dependencies: [{ task_name: 'Stake Lot', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Excavation'),
      lead_time_days: 0,
      sort_order: 2,
    },
    {
      id: uuid(),
      name: 'Footings',
      trade: 'concrete',
      phase: 'foundation',
      track: 'foundation',
      duration: 3,
      dependencies: [{ task_name: 'Excavation', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'PRE',
      is_outdoor: isOutdoor('Footings'),
      lead_time_days: 0,
      sort_order: 3,
    },
    {
      id: uuid(),
      name: 'Foundation Pour',
      trade: 'concrete',
      phase: 'foundation',
      track: 'foundation',
      duration: 1,
      dependencies: [{ task_name: 'Footings', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Foundation Pour'),
      lead_time_days: 0,
      sort_order: 4,
    },
    {
      id: uuid(),
      name: 'Foundation Cure',
      trade: 'concrete',
      phase: 'foundation',
      track: 'foundation',
      duration: 4,
      dependencies: [{ task_name: 'Foundation Pour', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'FND',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 5,
    },
    {
      id: uuid(),
      name: 'Backfill',
      trade: 'excavation',
      phase: 'foundation',
      track: 'foundation',
      duration: 1,
      dependencies: [{ task_name: 'Foundation Cure', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Backfill'),
      lead_time_days: 0,
      sort_order: 6,
    },

    // STRUCTURE (sequential)
    {
      id: uuid(),
      name: 'Framing',
      trade: 'framing',
      phase: 'framing',
      track: 'structure',
      duration: 10,
      dependencies: [{ task_name: 'Backfill', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Framing'),
      lead_time_days: 14,
      sort_order: 7,
    },
    {
      id: uuid(),
      name: 'Roof Sheathing',
      trade: 'roofing',
      phase: 'framing',
      track: 'structure',
      duration: 2,
      dependencies: [{ task_name: 'Framing', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Roof Sheathing'),
      lead_time_days: 0,
      sort_order: 8,
    },
    {
      id: uuid(),
      name: 'Roofing',
      trade: 'roofing',
      phase: 'framing',
      track: 'structure',
      duration: 4,
      dependencies: [{ task_name: 'Roof Sheathing', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'FRM',
      is_outdoor: isOutdoor('Roofing'),
      lead_time_days: 7,
      sort_order: 9,
    },
    {
      id: uuid(),
      name: 'Windows/Doors',
      trade: 'windows',
      phase: 'framing',
      track: 'structure',
      duration: 2,
      dependencies: [{ task_name: 'Roofing', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Windows/Doors'),
      lead_time_days: 28,
      sort_order: 10,
    },

    // INTERIOR (can run parallel with exterior; rough MEP in parallel)
    {
      id: uuid(),
      name: 'Rough Electrical',
      trade: 'electrical',
      phase: 'mechanical',
      track: 'interior',
      duration: 3,
      dependencies: [{ task_name: 'Windows/Doors', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'REL',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 20,
    },
    {
      id: uuid(),
      name: 'Rough Plumbing',
      trade: 'plumbing',
      phase: 'mechanical',
      track: 'interior',
      duration: 3,
      dependencies: [
        { task_name: 'Windows/Doors', type: 'FS', lag_days: 0 },
        { task_name: 'Rough Electrical', type: 'SS', lag_days: 0 },
      ],
      requires_inspection: true,
      inspection_type: 'RPL',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 21,
    },
    {
      id: uuid(),
      name: 'Rough HVAC',
      trade: 'hvac',
      phase: 'mechanical',
      track: 'interior',
      duration: 3,
      dependencies: [
        { task_name: 'Windows/Doors', type: 'FS', lag_days: 0 },
        { task_name: 'Rough Electrical', type: 'SS', lag_days: 0 },
      ],
      requires_inspection: true,
      inspection_type: 'RHV',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 22,
    },
    {
      id: uuid(),
      name: 'Insulation',
      trade: 'insulation',
      phase: 'insulation_drywall',
      track: 'interior',
      duration: 2,
      dependencies: [
        { task_name: 'Rough Electrical', type: 'FS', lag_days: 0 },
        { task_name: 'Rough Plumbing', type: 'FS', lag_days: 0 },
        { task_name: 'Rough HVAC', type: 'FS', lag_days: 0 },
      ],
      requires_inspection: true,
      inspection_type: 'INS',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 23,
    },
    {
      id: uuid(),
      name: 'Drywall Hang',
      trade: 'drywall',
      phase: 'insulation_drywall',
      track: 'interior',
      duration: 4,
      dependencies: [{ task_name: 'Insulation', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'DRY',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 24,
    },
    {
      id: uuid(),
      name: 'Drywall Finish',
      trade: 'drywall',
      phase: 'insulation_drywall',
      track: 'interior',
      duration: 5,
      dependencies: [{ task_name: 'Drywall Hang', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 25,
    },
    {
      id: uuid(),
      name: 'Interior Paint',
      trade: 'paint',
      phase: 'finishes',
      track: 'interior',
      duration: 5,
      dependencies: [{ task_name: 'Drywall Finish', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 26,
    },
    {
      id: uuid(),
      name: 'Cabinets',
      trade: 'cabinets',
      phase: 'finishes',
      track: 'interior',
      duration: 3,
      dependencies: [{ task_name: 'Interior Paint', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 30,
      sort_order: 27,
    },
    {
      id: uuid(),
      name: 'Countertops',
      trade: 'countertops',
      phase: 'finishes',
      track: 'interior',
      duration: 2,
      dependencies: [{ task_name: 'Cabinets', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 14,
      sort_order: 28,
    },
    {
      id: uuid(),
      name: 'Flooring',
      trade: 'flooring',
      phase: 'finishes',
      track: 'interior',
      duration: 4,
      dependencies: [{ task_name: 'Countertops', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 14,
      sort_order: 29,
    },
    {
      id: uuid(),
      name: 'Trim',
      trade: 'trim',
      phase: 'finishes',
      track: 'interior',
      duration: 5,
      dependencies: [{ task_name: 'Flooring', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 30,
    },
    {
      id: uuid(),
      name: 'Final Electrical',
      trade: 'electrical',
      phase: 'final',
      track: 'interior',
      duration: 2,
      dependencies: [{ task_name: 'Trim', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'FEL',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 31,
    },
    {
      id: uuid(),
      name: 'Final Plumbing',
      trade: 'plumbing',
      phase: 'final',
      track: 'interior',
      duration: 2,
      dependencies: [{ task_name: 'Final Electrical', type: 'SS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'FPL',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 32,
    },
    {
      id: uuid(),
      name: 'Final HVAC',
      trade: 'hvac',
      phase: 'final',
      track: 'interior',
      duration: 2,
      dependencies: [{ task_name: 'Final Electrical', type: 'SS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'FHV',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 33,
    },
    {
      id: uuid(),
      name: 'Appliances',
      trade: 'appliances',
      phase: 'final',
      track: 'interior',
      duration: 1,
      dependencies: [{ task_name: 'Final Electrical', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 14,
      sort_order: 34,
    },
    {
      id: uuid(),
      name: 'Final Touchups',
      trade: 'other',
      phase: 'final',
      track: 'interior',
      duration: 2,
      dependencies: [{ task_name: 'Appliances', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 35,
    },

    // EXTERIOR (parallel track)
    {
      id: uuid(),
      name: 'Siding',
      trade: 'siding',
      phase: 'exterior',
      track: 'exterior',
      duration: 5,
      dependencies: [{ task_name: 'Windows/Doors', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Siding'),
      lead_time_days: 0,
      sort_order: 40,
    },
    {
      id: uuid(),
      name: 'Exterior Brick/Stone',
      trade: 'siding',
      phase: 'exterior',
      track: 'exterior',
      duration: 4,
      dependencies: [{ task_name: 'Siding', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Exterior Brick/Stone'),
      lead_time_days: 0,
      sort_order: 41,
    },
    {
      id: uuid(),
      name: 'Exterior Paint',
      trade: 'paint',
      phase: 'exterior',
      track: 'exterior',
      duration: 3,
      dependencies: [{ task_name: 'Exterior Brick/Stone', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Exterior Paint'),
      lead_time_days: 0,
      sort_order: 42,
    },
    {
      id: uuid(),
      name: 'Gutters',
      trade: 'gutters',
      phase: 'exterior',
      track: 'exterior',
      duration: 1,
      dependencies: [{ task_name: 'Exterior Paint', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Gutters'),
      lead_time_days: 0,
      sort_order: 43,
    },
    {
      id: uuid(),
      name: 'Concrete Flatwork',
      trade: 'concrete',
      phase: 'exterior',
      track: 'exterior',
      duration: 3,
      dependencies: [{ task_name: 'Gutters', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Concrete Flatwork'),
      lead_time_days: 0,
      sort_order: 44,
    },
    {
      id: uuid(),
      name: 'Landscaping',
      trade: 'landscaping',
      phase: 'exterior',
      track: 'exterior',
      duration: 3,
      dependencies: [{ task_name: 'Concrete Flatwork', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Landscaping'),
      lead_time_days: 0,
      sort_order: 45,
    },
    {
      id: uuid(),
      name: 'Garage Door',
      trade: 'garage_door',
      phase: 'exterior',
      track: 'exterior',
      duration: 1,
      dependencies: [{ task_name: 'Exterior Paint', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: isOutdoor('Garage Door'),
      lead_time_days: 14,
      sort_order: 46,
    },

    // FINAL (sequential; must wait for interior + exterior)
    {
      id: uuid(),
      name: 'Final Clean',
      trade: 'cleaning',
      phase: 'final',
      track: 'final',
      duration: 2,
      dependencies: [{ task_name: 'Final Touchups', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'FIN',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 60,
    },
    {
      id: uuid(),
      name: 'Punch Complete',
      trade: 'other',
      phase: 'final',
      track: 'final',
      duration: 3,
      dependencies: [{ task_name: 'Final Clean', type: 'FS', lag_days: 0 }],
      requires_inspection: true,
      inspection_type: 'COO',
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 61,
    },
    {
      id: uuid(),
      name: 'Buyer Walkthrough',
      trade: 'other',
      phase: 'final',
      track: 'final',
      duration: 1,
      dependencies: [{ task_name: 'Punch Complete', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 62,
    },
    {
      id: uuid(),
      name: 'Handover',
      trade: 'other',
      phase: 'final',
      track: 'final',
      duration: 1,
      dependencies: [{ task_name: 'Buyer Walkthrough', type: 'FS', lag_days: 0 }],
      requires_inspection: false,
      inspection_type: null,
      is_outdoor: false,
      lead_time_days: 0,
      sort_order: 63,
    },
  ],
}

const cloneTasks = (tasks, durationScale = 1) =>
  (tasks ?? []).map((task) => ({
    ...task,
    id: uuid(),
    duration: Math.max(1, Math.round((task.duration ?? 1) * durationScale)),
  }))

const buildTemplateVariant = ({ id, name, build_days, durationScale }) => ({
  id,
  name,
  description: `${name} template.`,
  build_days,
  tasks: cloneTasks(DEFAULT_TEMPLATE.tasks, durationScale),
})

export const TEMPLATE_COTTAGE = buildTemplateVariant({
  id: 'template-cottage-115',
  name: 'Cottage Standard',
  build_days: 115,
  durationScale: 115 / 135,
})

export const TEMPLATE_RANCHER = buildTemplateVariant({
  id: 'template-rancher-130',
  name: 'Rancher Standard',
  build_days: 130,
  durationScale: 130 / 135,
})

export const TEMPLATE_TOWNHOME = buildTemplateVariant({
  id: 'template-townhome-145',
  name: 'Townhome Standard',
  build_days: 145,
  durationScale: 145 / 135,
})

export const TEMPLATES = [TEMPLATE_COTTAGE, TEMPLATE_RANCHER, TEMPLATE_TOWNHOME]
